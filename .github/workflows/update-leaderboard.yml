name: Update leaderboard snapshot

on:
  schedule:
    - cron: "0 * * * *" # 매시간 캐시 갱신 시도
  workflow_dispatch:

permissions:
  contents: write # data/*를 커밋/푸시하려면 write 권한 필요

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download leaderboard HTML
        run: |
          set -euo pipefail
          mkdir -p data
          curl -L "https://dacon.io/competitions/official/236624/leaderboard" -o data/leaderboard.html

      - name: Build summary JSON
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import re, json, pathlib, datetime
          html = pathlib.Path("data/leaderboard.html").read_text()
          pattern = re.compile(r'<li class="vote[^>]*>\s*<span[^>]*>\s*([\d,]+)\s*</span>.*?<li class="date', re.S)
          votes = [int(x.replace(",", "")) for x in pattern.findall(html)]
          data = {
              "totalVotes": sum(votes),
              "voteValues": votes,
              "teamCount": len(votes),
              "updatedAt": datetime.datetime.utcnow().isoformat() + "Z",
          }
          path = pathlib.Path("data/summary.json")
          path.write_text(json.dumps(data, ensure_ascii=False, indent=2))
          print(f"found {len(votes)} votes, sum {sum(votes)}, wrote {path}")
          PY

      - name: Commit & push if changed
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: actions@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions
          GIT_COMMITTER_EMAIL: actions@users.noreply.github.com
        run: |
          set -euo pipefail
          if git status --porcelain | grep .; then
            git add data/leaderboard.html data/summary.json
            git commit -m "chore: refresh leaderboard snapshot"
            git push
          else
            echo "No changes to commit."
          fi
